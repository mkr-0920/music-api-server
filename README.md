# ğŸµ å…¨èƒ½éŸ³ä¹ API æœåŠ¡å™¨

> ä¸€ä¸ªé›†æˆäº† Web ç•Œé¢ã€æ™ºèƒ½å·¥å…·å’Œå¤šæºéŸ³ä¹ APIï¼ˆæœ¬åœ°ã€QQéŸ³ä¹ã€ç½‘æ˜“äº‘éŸ³ä¹ï¼‰çš„ç§æœ‰åŒ–è§£å†³æ–¹æ¡ˆã€‚

ä¸ºæ‚¨çš„éŸ³ä¹ç®¡ç†å’Œæ’­æ”¾æä¾›å¼ºå¤§è€Œç»Ÿä¸€çš„åå°ï¼Œæ”¯æŒï¼š
- æ™ºèƒ½æœç´¢
- æ‰¹é‡ä¸‹è½½
- å…ƒæ•°æ®è‡ªåŠ¨è¡¥å…¨ä¸å¢å¼º
- æ–‡ä»¶è‡ªåŠ¨æ•´ç†
- Cookie ç»­æœŸ
- å¯†é’¥ä¿æŠ¤

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ”— å¤šæºèšåˆ
æ— ç¼æ•´åˆä¸‰å¤§éŸ³ä¹æ¥æºï¼š
- æœ¬åœ°éŸ³ä¹åº“
- QQ éŸ³ä¹
- ç½‘æ˜“äº‘éŸ³ä¹

---

### ğŸ–¥ï¸ Web æ“ä½œç•Œé¢

#### `music_parser.html` â€” ä¸»æ“ä½œé¢æ¿
å›¾å½¢åŒ–ç•Œé¢ï¼Œæ”¯æŒé€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨æ‰€æœ‰ API åŠŸèƒ½ï¼š
- å•æ›² ID / MID
- æ­Œå•æˆ–ä¸“è¾‘ ID
- å…³é”®è¯æœç´¢

#### `delete_songs.html` â€” æœ¬åœ°åº“ç®¡ç†åå°
- æµè§ˆæœ¬åœ°æ­Œæ›²åº“
- å®æ—¶å…³é”®è¯ç­›é€‰
- å¤é€‰æ¡†æ‰¹é‡é€‰æ‹©
- å®‰å…¨åˆ é™¤ï¼ˆæ•°æ®åº“ + ç¡¬ç›˜åŒæ­¥ï¼‰

---

### ğŸ“¥ æ™ºèƒ½æ‰¹é‡ä¸‹è½½
- åœ¨`config.py`å¼€å¯æˆ–å…³é—­ï¼Œæœ‰`NAS`æˆ–æ˜¯æƒ³è‡ªå»ºéŸ³ä¹åº“çš„å¯ä»¥å¼€å¯
- æ”¯æŒé€šè¿‡ **æ­Œå• ID** æˆ– **ä¸“è¾‘ ID** å¼‚æ­¥åŠ å…¥åå°ä¸‹è½½é˜Ÿåˆ—ã€‚
- **æ™ºèƒ½åˆ†å±‚ä¸‹è½½**ï¼šè‡ªåŠ¨ä¸‹è½½æœ€é«˜éŸ³è´¨ç‰ˆæœ¬ï¼ŒæŒ‰è®¾ç½®ï¼ˆå¦‚ `master` ä¼˜å…ˆï¼‰æ™ºèƒ½è¡¥å……æˆ–è·³è¿‡ã€‚

---

### ğŸ·ï¸ å…ƒæ•°æ®è‡ªåŠ¨è¡¥å…¨

#### ä¸‹è½½æ—¶å†™å…¥
åœ¨çº¿æ­Œæ›²ä¸‹è½½æ—¶ï¼Œè‡ªåŠ¨æŠ“å–å¹¶åµŒå…¥å¤šè¾¾ **14 é¡¹å…ƒæ•°æ®**ï¼ŒåŒ…æ‹¬ï¼š
- æ ‡é¢˜
- è‰ºæœ¯å®¶
- ä½œè¯
- ä½œæ›²
- å‘è¡Œå¹´ä»½
- ä¸“è¾‘è‰ºæœ¯å®¶ç­‰

#### æœ¬åœ°åº“å¢å¼º
ç‹¬ç«‹è„šæœ¬ï¼š`metadata_enhancer.py`  
æ‰«æç°æœ‰æœ¬åœ°éŸ³ä¹åº“ï¼Œä½¿ç”¨ç½‘æ˜“äº‘æ•°æ®æ™ºèƒ½è¡¥å…¨ç¼ºå¤±å­—æ®µï¼ˆå¦‚â€œæ›²é£â€ï¼‰ã€‚

```bash
python metadata_enhancer.py --dry-run    # é¢„è§ˆæ”¹åŠ¨
python metadata_enhancer.py              # æ‰§è¡Œå†™å…¥
```

---

### ğŸ—‚ï¸ æ–‡ä»¶è‡ªåŠ¨æ•´ç†

#### æ™ºèƒ½åˆ†æµ
- è‹¥ `master` ç‰ˆæœ¬å·²å­˜åœ¨ï¼Œ`flac` ç‰ˆæœ¬è‡ªåŠ¨ä¸‹è½½è‡³å¤‡ç”¨ç›®å½•ã€‚

---

### ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡

| åŠŸèƒ½             | è¯´æ˜ |
|------------------|------|
| è‡ªåŠ¨é‡è¯•         | ä¸‹è½½å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œè§£å†³ä¸´æ—¶ç½‘ç»œé—®é¢˜ |
| å¤±è´¥æ—¥å¿—         | è®°å½•æ— æ³•ä¸‹è½½çš„æ­Œæ›²ï¼Œä¾¿äºåç»­å¤„ç† |
| Cookie è‡ªåŠ¨ç»­æœŸ  | å†…ç½®å®šæ—¶ä»»åŠ¡åˆ·æ–° QQ éŸ³ä¹ Cookieï¼Œä¸€æ¬¡é…ç½®é•¿æœŸæœ‰æ•ˆ |
| API å¯†é’¥ä¿æŠ¤     | æ‰€æœ‰æ¥å£éœ€æºå¸¦ `X-API-Key` è¯·æ±‚å¤´è®¤è¯ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›® & é…ç½®

```bash
git clone https://github.com/mkr-0920/music-api-server.git
cd music-api-server
cp core/config.py.template core/config.py
nano core/config.py
```

> âš ï¸ **è¯·åŠ¡å¿…å¡«å†™ä»¥ä¸‹å…³é”®é…ç½®é¡¹ï¼š**
> - `API_SECRET_KEY`
> - `QQ_USER_CONFIG`
> - `NETEASE_COOKIE_STR`
> - `MUSIC_DIRECTORY`
> - `FLAC_DIRECTORY`

---

### 2. å®‰è£…ä¾èµ–

```bash
# ï¼ˆæ¨èï¼‰åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

---

### 3. åˆå§‹åŒ–æ•°æ®åº“

é¦–æ¬¡è¿è¡Œæˆ–æ–°å¢åŠŸèƒ½åï¼Œè¯·æ‰§è¡Œï¼š

```bash
python scanner.py
```

> æ­¤è„šæœ¬ä¼šæ‰«æ `MUSIC_DIRECTORY` å’Œ `FLAC_DIRECTORY`ï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥æ•°æ®åº“ã€‚

---

### 4. å¯åŠ¨æœåŠ¡

```bash
python main.py
```

âœ… æœåŠ¡å¯åŠ¨åè®¿é—®ï¼š  
ğŸ‘‰ `http://<ä½ çš„æœåŠ¡å™¨IP>:5000`

> è‹¥å·²é…ç½® Nginxï¼Œå¯ç›´æ¥è®¿é—®ä½ çš„åŸŸåã€‚

---

## ğŸŒ Web ç•Œé¢ä½¿ç”¨

### ğŸ›ï¸ `music_parser.html`ï¼ˆä¸»è§£æå™¨ï¼‰

æ”¯æŒåŠŸèƒ½ï¼š
- **å•æ›²è§£æ**ï¼šè¾“å…¥æ­Œæ›² ID/MIDï¼Œè·å–ä¿¡æ¯ä¸æ’­æ”¾é“¾æ¥
- **ID ä¸‹è½½**ï¼šè¾“å…¥æ­Œå•/ä¸“è¾‘ IDï¼Œè§¦å‘åå°æ‰¹é‡ä¸‹è½½
- **å…³é”®è¯æœç´¢**ï¼šè·¨å¹³å°æœç´¢å¹¶è‡ªåŠ¨ä¸‹è½½æœ€é«˜éŸ³è´¨ç‰ˆæœ¬

---

### ğŸ—‘ï¸ `delete_songs.html`ï¼ˆæœ¬åœ°åº“ç®¡ç†ï¼‰

- å®Œæ•´æœ¬åœ°éŸ³ä¹åº“è§†å›¾
- å®æ—¶å…³é”®è¯ç­›é€‰
- å¤é€‰æ¡†æ‰¹é‡æ“ä½œ
- å®‰å…¨åˆ é™¤ï¼ˆæ•°æ®åº“ + æ–‡ä»¶ç³»ç»ŸåŒæ­¥ï¼‰

---

## ğŸ› ï¸ å‘½ä»¤è¡Œå·¥å…·

### `scanner.py` â€” æ‰«æä¸ç´¢å¼•

```bash
python scanner.py
```

> æ‰«æéŸ³ä¹ç›®å½•å¹¶æ›´æ–°æ•°æ®åº“ã€‚

---

### `metadata_enhancer.py` â€” å…ƒæ•°æ®å¢å¼º

```bash
python metadata_enhancer.py --dry-run    # é¢„è§ˆ
python metadata_enhancer.py              # å†™å…¥
```

> ä½¿ç”¨ç½‘æ˜“äº‘æ•°æ®è¡¥å…¨æœ¬åœ°åº“ç¼ºå¤±å…ƒæ•°æ®ï¼ˆå¦‚â€œæ›²é£â€ï¼‰ã€‚

---

### `separate_flac.py` â€” FLAC åˆ†ç¦»æ•´ç†

```bash
python separate_flac.py --dry-run    # é¢„è§ˆ
python separate_flac.py              # æ‰§è¡Œ
```

> è‹¥æ­Œæ›²åŒæ—¶å­˜åœ¨ `master` å’Œ `flac`ï¼Œè‡ªåŠ¨å°† `flac` ç§»è‡³å¤‡ç”¨ç›®å½•å¹¶æ›´æ–°æ•°æ®åº“ã€‚

---

### `delete_songs.py` â€” æ­Œæ›²åˆ é™¤å·¥å…·

```bash
python delete_songs.py
```

> äº¤äº’å¼ CLIï¼Œå®‰å…¨åˆ é™¤ä¸€é¦–æˆ–å¤šé¦–æ­Œæ›²ï¼ˆæ•°æ®åº“ + ç¡¬ç›˜ï¼‰ã€‚

---

## ğŸ“– API ä½¿ç”¨è¯´æ˜

> ğŸ“Œ **æ‰€æœ‰è¯·æ±‚å¿…é¡»æºå¸¦è®¤è¯å¤´ï¼š**  
> `X-API-Key: YOUR_SECRET_KEY`

---

### 1. åœ¨çº¿éŸ³ä¹ APIï¼ˆ`/api/qq`, `/api/netease`ï¼‰

**æ–¹æ³•ï¼š** `GET`  
**æè¿°ï¼š** æœç´¢ã€è·å–è¯¦æƒ…ã€è§¦å‘æ‰¹é‡ä¸‹è½½

#### æ ¸å¿ƒå‚æ•°

| å‚æ•°          | å¹³å°       | è¯´æ˜                     |
|---------------|------------|--------------------------|
| `q`           | é€šç”¨       | å…³é”®è¯ï¼Œæ ¼å¼ï¼š`æ­Œæ‰‹ - æ­Œæ›²å` |
| `album`       | é€šç”¨       | ä¸“è¾‘åï¼Œç”¨äºç²¾ç¡®è¿‡æ»¤æœç´¢     |
| `id` / `mid`  | QQéŸ³ä¹     | songidï¼ˆæ•°å­—ï¼‰æˆ– songmid     |
| `id`          | ç½‘æ˜“äº‘     | æ­Œæ›² id                   |
| `playlist_id` | é€šç”¨       | æ­Œå• IDï¼Œè§¦å‘æ‰¹é‡ä¸‹è½½        |
| `album_id`    | é€šç”¨       | ä¸“è¾‘ IDï¼Œè§¦å‘æ‰¹é‡ä¸‹è½½        |
| `level`       | ç½‘æ˜“äº‘     | éŸ³è´¨ç­‰çº§ï¼ˆå¦‚ `hires`ï¼‰       |

---

#### ç¤ºä¾‹è¯·æ±‚

##### ğŸ” æŒ‰å…³é”®è¯æœç´¢

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  --data-urlencode "q=å‘¨æ°ä¼¦ - ç¨»é¦™" \
  "http://127.0.0.1:5000/api/qq"
```

##### ğŸµ æŒ‰ ID è·å–å•æ›²

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "http://127.0.0.1:5000/api/netease?id=191179"
```

##### ğŸ“¥æŒ‰ ID ä¸‹è½½æ­Œå•

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "http://127.0.0.1:5000/api/netease?playlist_id=8473556052"
```

##### ğŸ“¦æŒ‰ ID ä¸‹è½½ä¸“è¾‘

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "http://127.0.0.1:5000/api/qq?album_id=003DF0bQ31w25h"
```

---

### 2. æœ¬åœ°éŸ³ä¹ API

#### a) æœç´¢æœ¬åœ°æ­Œæ›² `/api/local/search`

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  --data-urlencode "q=å‘¨æ°ä¼¦ - å¯çˆ±å¥³äºº \
  "http://127.0.0.1:5000/api/local/search"
```

#### b) ä¸‹è½½æœ¬åœ°æ­Œæ›² `/api/local/download/<id>`


```bash
curl -L -o "song.flac" "http://127.0.0.1:5000/api/local/download/123"
```

#### c) åˆ—å‡ºæ‰€æœ‰æœ¬åœ°æ­Œæ›² `/api/local/list`

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "http://127.0.0.1:5000/api/local/list"
```

#### d) åˆ é™¤æœ¬åœ°æ­Œæ›² `/api/local/delete`

```bash
curl -X POST -H "X-API-Key: YOUR_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{"ids": [123, 456]}' \
  "http://127.0.0.1:5000/api/local/delete
```
---

