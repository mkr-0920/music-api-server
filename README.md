# ğŸµ å…¨èƒ½éŸ³ä¹APIæœåŠ¡å™¨

> ä¸€ä¸ªé›†æˆäº†Webç•Œé¢ã€æ™ºèƒ½å·¥å…·å’Œå¤šæºéŸ³ä¹APIï¼ˆæœ¬åœ°ã€QQéŸ³ä¹ã€ç½‘æ˜“äº‘éŸ³ä¹ï¼‰çš„ç§æœ‰åŒ–è§£å†³æ–¹æ¡ˆã€‚

ä¸ºæ‚¨çš„éŸ³ä¹ç®¡ç†å’Œæ’­æ”¾æä¾›å¼ºå¤§è€Œç»Ÿä¸€çš„åå°ï¼Œæ”¯æŒï¼š
- æ™ºèƒ½æœç´¢
- æ‰¹é‡ä¸‹è½½
- å…ƒæ•°æ®è‡ªåŠ¨è¡¥å…¨ä¸å¢å¼º
- æ–‡ä»¶è‡ªåŠ¨æ•´ç†
- æ­Œå•è‡ªåŠ¨åŒæ­¥
- Cookie ç»­æœŸ
- å¯†é’¥ä¿æŠ¤

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ”— å¤šæºèšåˆ
æ— ç¼æ•´åˆä¸‰å¤§éŸ³ä¹æ¥æºï¼š
- æœ¬åœ°éŸ³ä¹åº“ (ç”± `scanner.py` ç´¢å¼•)
- QQ éŸ³ä¹
- ç½‘æ˜“äº‘éŸ³ä¹

---

### ğŸ–¥ï¸ Web æ“ä½œç•Œé¢

#### `music_parser.html` â€” ä¸»æ“ä½œé¢æ¿
å›¾å½¢åŒ–ç•Œé¢ï¼Œæ”¯æŒé€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨æ‰€æœ‰ API åŠŸèƒ½ï¼š
- **å•æ›²è§£æ**: è¾“å…¥æ­Œæ›² ID/MIDï¼Œè·å–ä¿¡æ¯ä¸æ’­æ”¾é“¾æ¥ã€‚
- **åå°æ‰¹é‡ä¸‹è½½**: è¾“å…¥æ­Œå•/ä¸“è¾‘ IDï¼Œè§¦å‘åå°æ‰¹é‡ä¸‹è½½ã€‚
- **å…³é”®è¯æœç´¢**: è·¨å¹³å°æœç´¢å¹¶è‡ªåŠ¨ä¸‹è½½æœ€é«˜éŸ³è´¨ç‰ˆæœ¬ã€‚

#### `delete_songs.html` â€” æœ¬åœ°åº“ç®¡ç†åå°
- æµè§ˆæœ¬åœ°æ­Œæ›²åº“ï¼Œæ”¯æŒå®æ—¶å…³é”®è¯ç­›é€‰ã€‚
- å¤é€‰æ¡†æ‰¹é‡é€‰æ‹©ï¼Œå®‰å…¨åˆ é™¤ï¼ˆæ•°æ®åº“ + ç¡¬ç›˜åŒæ­¥ï¼‰ã€‚

#### `playlist_importer.html` â€” Navidrome æ­Œå•å¯¼å…¥
- å°†åœ¨çº¿æ­Œå•ï¼ˆQQéŸ³ä¹/ç½‘æ˜“äº‘ï¼‰ä¸€é”®å¯¼å…¥æ‚¨çš„ Navidromeã€‚
- è‡ªåŠ¨åœ¨æœ¬åœ°åº“ä¸­åŒ¹é…æ­Œæ›²ï¼Œå¹¶åˆ›å»ºåŒåæ­Œå•ã€‚
- è‡ªåŠ¨åœ¨æ•°æ®åº“ä¸­åˆ›å»º**æ˜ å°„å…³ç³»**ï¼Œä¸ºæ­Œå•åŒæ­¥åšå‡†å¤‡ã€‚

#### `netease_crypto_tool.html` â€” å¼€å‘è€…å·¥å…·
- ç”¨äºè°ƒè¯•ç½‘æ˜“äº‘ EAPI æ¥å£ã€‚
- æ”¯æŒ**åŠ å¯†**è¯·æ±‚ä½“ (Payload -> params)ã€‚
- æ”¯æŒ**è§£å¯†**è¯·æ±‚ä½“ (params -> Payload)ã€‚
- æ”¯æŒ**è§£å¯†**å“åº”ä½“ (Response -> JSON)ã€‚

---

### ğŸ“¥ æ™ºèƒ½æ‰¹é‡ä¸‹è½½
- åœ¨`config.py`ä¸­é€šè¿‡ `DOWNLOADS_ENABLED` å¼€å¯æˆ–å…³é—­ã€‚
- æ”¯æŒé€šè¿‡ **æ­Œå• ID** æˆ– **ä¸“è¾‘ ID** å¼‚æ­¥åŠ å…¥åå°ä¸‹è½½é˜Ÿåˆ—ã€‚
- **æ™ºèƒ½åˆ†å±‚ä¸‹è½½**ï¼šè‡ªåŠ¨ä¸‹è½½æœ€é«˜éŸ³è´¨ç‰ˆæœ¬ï¼ŒæŒ‰è®¾ç½®ï¼ˆå¦‚ `master` ä¼˜å…ˆï¼‰æ™ºèƒ½è¡¥å……æˆ–è·³è¿‡ã€‚

---

### ğŸ·ï¸ å…ƒæ•°æ®è‡ªåŠ¨è¡¥å…¨

#### ä¸‹è½½æ—¶å†™å…¥
åœ¨çº¿æ­Œæ›²ä¸‹è½½æ—¶ï¼Œè‡ªåŠ¨æŠ“å–å¹¶åµŒå…¥å¤šè¾¾ **14 é¡¹å…ƒæ•°æ®**ï¼ŒåŒ…æ‹¬ï¼š
- æ ‡é¢˜, è‰ºæœ¯å®¶, ä¸“è¾‘, ä¸“è¾‘è‰ºæœ¯å®¶
- ä½œè¯, ä½œæ›², ç¼–æ›², åˆ¶ä½œäºº, æ··éŸ³, æ¯å¸¦
- å‘è¡Œå¹´ä»½, æ›²é£, BPM, å°é¢

#### æœ¬åœ°åº“å¢å¼º (`metadata_enhancer.py`)
æ‰«æç°æœ‰æœ¬åœ°éŸ³ä¹åº“ï¼Œä½¿ç”¨ç½‘æ˜“äº‘æ•°æ®æ™ºèƒ½è¡¥å…¨ç¼ºå¤±å­—æ®µï¼ˆå¦‚â€œæ›²é£â€ï¼‰ã€‚
```bash
python metadata_enhancer.py --dry-run   # é¢„è§ˆæ”¹åŠ¨
python metadata_enhancer.py           # æ‰§è¡Œå†™å…¥
````


-----

### ğŸ—‚ï¸ æ–‡ä»¶è‡ªåŠ¨æ•´ç†ä¸è‡ªåŠ¨åŒ–

#### æ™ºèƒ½åˆ†æµ

  - åœ¨`config.py`å¼€å¯æˆ–å…³é—­ï¼šè‹¥ `master` ç‰ˆæœ¬å·²å­˜åœ¨ï¼Œ`flac` ç‰ˆæœ¬è‡ªåŠ¨ä¸‹è½½è‡³ `FLAC_DIRECTORY` å¤‡ç”¨ç›®å½•ã€‚

-----

### ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡

| åŠŸèƒ½ | è¯´æ˜ |
|---|---|
| è‡ªåŠ¨é‡è¯• | ä¸‹è½½å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œè§£å†³ä¸´æ—¶ç½‘ç»œé—®é¢˜ |
| å¤±è´¥æ—¥å¿— | è®°å½•æ— æ³•ä¸‹è½½çš„æ­Œæ›²ï¼Œä¾¿äºåç»­å¤„ç† |
| Cookie è‡ªåŠ¨ç»­æœŸ | å†…ç½®å®šæ—¶ä»»åŠ¡åˆ·æ–° QQ éŸ³ä¹ Cookieï¼Œä¸€æ¬¡é…ç½®é•¿æœŸæœ‰æ•ˆ |
| API å¯†é’¥ä¿æŠ¤ | æ‰€æœ‰æ¥å£éœ€æºå¸¦ `X-API-Key` è¯·æ±‚å¤´æˆ– `api_key` å‚æ•°è®¤è¯ |

-----

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1\. å…‹éš†é¡¹ç›® & é…ç½®

```bash
git clone https://github.com/mkr-0920/music-api-server.git
cd music-api-server
cp core/config.py.template core/config.py
nano core/config.py
```

> âš ï¸ **è¯·åŠ¡å¿…å¡«å†™ä»¥ä¸‹å…³é”®é…ç½®é¡¹ï¼š**
>
>   - `API_SECRET_KEY`
>   - `QQ_USER_CONFIG`
>   - `NETEASE_COOKIE_STR`
>   - `MUSIC_DIRECTORY`
>   - `FLAC_DIRECTORY`
>   - `INSTRUMENTAL_DIRECTORY`

-----

### 2\. å®‰è£…ä¾èµ–

```bash
# ï¼ˆæ¨èï¼‰åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

-----

### 3\. åˆå§‹åŒ–æ•°æ®åº“

é¦–æ¬¡è¿è¡Œæˆ–æ–°å¢åŠŸèƒ½åï¼Œè¯·æ‰§è¡Œï¼š

```bash
python scanner.py
```

> æ­¤è„šæœ¬ä¼šæ‰«æ `MUSIC_DIRECTORY` å’Œ `FLAC_DIRECTORY`ï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥æ•°æ®åº“ã€‚

-----

### 4\. å¯åŠ¨æœåŠ¡

æœ¬é¡¹ç›®å·²å‡çº§ä¸º **FastAPI** æ¶æ„ï¼Œè¯·ä½¿ç”¨ `uvicorn` å¯åŠ¨ï¼š

```bash
uvicorn main:app --host 0.0.0.0 --port 5000
```

> **ï¼ˆæ¨èï¼‰** ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `workers` å‚æ•°ï¼š
> `uvicorn main:app --host 0.0.0.0 --port 5000 --workers 4`

-----

## ğŸ› ï¸ å‘½ä»¤è¡Œå·¥å…·

### `scanner.py` â€” æ‰«æä¸ç´¢å¼•

```bash
python scanner.py
```

> æ‰«æéŸ³ä¹ç›®å½•å¹¶æ›´æ–°æ•°æ®åº“ã€‚

-----

### `metadata_enhancer.py` â€” å…ƒæ•°æ®å¢å¼º

```bash
python metadata_enhancer.py --dry-run   # é¢„è§ˆ
python metadata_enhancer.py           # å†™å…¥
```

> ä½¿ç”¨ç½‘æ˜“äº‘æ•°æ®è¡¥å…¨æœ¬åœ°åº“ç¼ºå¤±å…ƒæ•°æ®ï¼ˆå¦‚â€œæ›²é£â€ï¼‰ã€‚

-----


### `delete_songs.py` â€” æ­Œæ›²åˆ é™¤å·¥å…·

```bash
python delete_songs.py
```

> äº¤äº’å¼ CLIï¼Œå®‰å…¨åˆ é™¤ä¸€é¦–æˆ–å¤šé¦–æ­Œæ›²ï¼ˆæ•°æ®åº“ + ç¡¬ç›˜ï¼‰ã€‚

-----

### `playlist_sync.py` â€” Navidrome æ­Œå•åŒæ­¥

```bash
# ç¤ºä¾‹ï¼šåŒæ­¥æ‰€æœ‰å·²æ˜ å°„çš„æ­Œå•
python playlist_sync.py --navidrome-url http://... --username ... --password ... --all
  
# ç¤ºä¾‹ï¼šåªåŒæ­¥æ˜ å°„IDä¸º 1 çš„æ­Œå•
python playlist_sync.py --navidrome-url http://... --username ... --password ... --id 1
```

> æ£€æŸ¥å·²å¯¼å…¥çš„åœ¨çº¿æ­Œå•æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¹¶è‡ªåŠ¨å°†å˜åŠ¨ï¼ˆæ–°å¢ã€ç§»é™¤å’Œé¡ºåºå˜æ›´ï¼‰åŒæ­¥åˆ° Navidromeã€‚

-----

## ğŸ“– API ä½¿ç”¨è¯´æ˜

> ğŸ“Œ **æ‰€æœ‰è¯·æ±‚å¿…é¡»æºå¸¦è®¤è¯å¤´ï¼š** Â 
> `X-API-Key: YOUR_SECRET_KEY`

-----

### 1\. åœ¨çº¿éŸ³ä¹ API (`/api/qq`, `/api/netease`)

**æ–¹æ³•ï¼š** `GET` Â 
**æè¿°ï¼š** æœç´¢ã€è·å–è¯¦æƒ…ã€è§¦å‘æ‰¹é‡ä¸‹è½½

#### æ ¸å¿ƒå‚æ•°

| å‚æ•° | å¹³å° | è¯´æ˜ |
|---|---|---|
| `q` | é€šç”¨ | å…³é”®è¯ï¼Œæ ¼å¼ï¼š`æ­Œæ‰‹ - æ­Œæ›²å` |
| `album` | é€šç”¨ | ä¸“è¾‘åï¼Œç”¨äºç²¾ç¡®è¿‡æ»¤æœç´¢ |
| `id` / `mid` | QQéŸ³ä¹ | songidï¼ˆæ•°å­—ï¼‰æˆ– songmid |
| `id` | ç½‘æ˜“äº‘ | æ­Œæ›² id |
| `playlist_id` | é€šç”¨ | æ­Œå• IDï¼Œè§¦å‘åå°æ‰¹é‡ä¸‹è½½ |
| `album_id` | é€šç”¨ | ä¸“è¾‘ IDï¼Œè§¦å‘åå°æ‰¹é‡ä¸‹è½½ |
| `level` | ç½‘æ˜“äº‘ | éŸ³è´¨ç­‰çº§ï¼ˆå¦‚ `hires`ï¼‰ |

-----

#### ç¤ºä¾‹è¯·æ±‚

##### ğŸ” æŒ‰å…³é”®è¯æœç´¢

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  --data-urlencode "q=å‘¨æ°ä¼¦ - ç¨»é¦™" \
  "https://127.0.0.1:5000/api/qq"
```

##### ğŸµ æŒ‰ ID è·å–å•æ›²

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "https://127.0.0.1:5000/api/netease?id=191179"
```

##### ğŸ“¥æŒ‰ ID ä¸‹è½½æ­Œå•

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "https://127.0.0.1:5000/api/netease?playlist_id=8473556052"
```

##### ğŸ“¦æŒ‰ ID ä¸‹è½½ä¸“è¾‘

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "https://127.0.0.1:5000/api/qq?album_id=003DF0bQ31w25h"
```

-----

### 2\. æœ¬åœ°éŸ³ä¹ API

#### a) æœç´¢æœ¬åœ°æ­Œæ›² `/api/local/search`

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  --data-urlencode "q=å‘¨æ°ä¼¦ - å¯çˆ±å¥³äºº" \
  "https://127.0.0.1:5000/api/local/search"
```

#### b) è·å–æµåª’ä½“é“¾æ¥ `/api/local/stream_url/<id>`

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  "https://127.0.0.1:5000/api/local/stream_url/123"
```

#### c) åˆ—å‡ºæ‰€æœ‰æœ¬åœ°æ­Œæ›² `/api/local/list`

```bash
curl -H "X-API-Key: YOUR_SECRET_KEY" \
  "https://127.0.0.1:5000/api/local/list"
```

#### d) åˆ é™¤æœ¬åœ°æ­Œæ›² `/api/local/delete`

```bash
curl -X POST -H "X-API-Key: YOUR_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{"ids": [123, 456]}' \
  "https://127.0.0.1:5000/api/local/delete"
```

-----

### 3\. æ­Œå•å¯¼å…¥ API

#### a) è·å–åœ¨çº¿æ­Œå•ä¿¡æ¯ `/api/playlist/info`

```bash
curl -G -H "X-API-Key: YOUR_SECRET_KEY" \
  --data-urlencode "platform=netease" \
  --data-urlencode "id=8473556052" \
  "https://127.0.0.1:5000/api/playlist/info"
```

#### b) å¯¼å…¥æ­Œå•åˆ° Navidrome `/api/navidrome/import`

```bash
curl -X POST -H "X-API-Key: YOUR_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{
        "navidrome_url": "http://127.0.0.1:4533",
        "username": "YOUR_NAVI_USER",
        "password": "YOUR_NAVI_PASSWORD",
        "platform": "netease",
        "online_playlist_id": "8473556052"
     }' \
  "https://127.0.0.1:5000/api/navidrome/import"
```
